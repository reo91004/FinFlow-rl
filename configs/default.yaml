# configs/default.yaml
# BIPD 2.0 기본 설정 파일

seed: 42
device: auto # cpu|cuda|auto

# 데이터 설정
data:
  symbols: [
      "AAPL",
      "MSFT",
      "AMZN",
      "UNH",
      "JNJ",
      "JPM",
      "V",
      "WMT",
      "CVX",
      "PG",
      "HD",
      "MRK",
      "KO",
      "DIS",
      "MCD",
      "CSCO",
      "VZ",
      "NKE",
      "GS",
      "AXP",
      "BA",
      "IBM",
      "CAT",
      "MMM",
      "TRV",
      "HON",
      "DOW",
      "INTC",
      "WBA",
      "CRM",
    ] # 다우존스 30 (2024년 기준)
  start: "2008-01-01"
  end: "2020-12-31"
  test_start: "2021-01-01"
  test_end: "2024-12-31"
  interval: "1d"
  cache_dir: "data/cache"

# 특성 추출 설정
features:
  window: 20
  # 동적 feature 설정
  dimensions:
    returns: 3 # 최근 수익률, 평균 수익률, 변동성
    technical: 4 # RSI, MACD, Bollinger, Volume
    structure: 3 # 상관관계, 베타, 최대 낙폭
    momentum: 2 # 단기, 장기 모멘텀
  total_dim: 12 # 총 feature 차원 (sum of above)
  indicators: ["returns", "vol_ema", "momentum", "rsi", "macd", "bollinger", "correlation"]
  normalize: true

# 환경 설정
env:
  initial_capital: 1000000
  turnover_cost: 0.001 # 10 bps
  slip_coeff: 0.0005 # 슬리피지
  no_trade_band: 0.002 # 0.2% 이하 변화 무시
  max_leverage: 1.0 # 레버리지 제한
  max_turnover: 0.5 # 일일 최대 턴오버

# T-Cell 설정 (위기 감지)
tcell:
  method: "iforest" # iforest|bocpd|hmm
  contamination: 0.1
  n_estimators: 100
  ema_beta: 0.9
  shap_topk: 5
  crisis_thresholds:
    high: 0.7
    medium: 0.4

# B-Cell 설정 (강화학습)
bcell:
  # 오프라인 사전학습
  offline_algo: "iql"
  iql_expectile: 0.7 # IQL 원논문 기본값 (Kostrikov et al., 2022)
  iql_temperature: 3.0 # IQL 원논문 기본값

  # 온라인 학습
  online_algo: "dist_sac_cql"

  # 네트워크 구조
  actor_hidden: [256, 256]
  critic_hidden: [256, 256]
  n_quantiles: 32

  # 학습률
  actor_lr: 3.0e-4 # 원논문 기본값 유지
  critic_lr: 3.0e-4
  alpha_lr: 3.0e-4

  # SAC 파라미터
  gamma: 0.99
  tau: 0.005
  alpha_init: 0.2
  alpha_min: 5.0e-4
  alpha_max: 0.2
  target_entropy_ratio: 0.98

  # CQL 설정
  cql_alpha_start: 0.01
  cql_alpha_end: 0.05
  cql_num_samples: 8

  # Gradient clipping
  grad_clip: 1.0

# Memory Cell 설정
memory:
  capacity: 500
  embedding_dim: 32
  similarity_threshold: 0.7
  k_neighbors: 5

# Gating Network 설정
gating:
  hidden_dim: 128
  temperature: 1.0
  min_dwell_steps: 5

# 학습 단계별 안전 설정
safety_stages:
  warmup:  # Episode 1-20
    max_turnover: 0.3
    cql_weight: 10.0
    lr_scale: 0.5
    min_buffer_size: 256

  stabilization:  # Episode 21-50
    max_turnover: 0.5
    cql_weight: 5.0
    lr_scale: 0.75
    min_buffer_size: 512

  exploration:  # Episode 51+
    max_turnover: 0.9
    cql_weight: 1.0
    lr_scale: 1.0
    min_buffer_size: 1000

# NaN/Inf 방지 설정
stability:
  check_interval: 100  # 네트워크 검사 간격
  max_reward: 10.0  # 최대 보상 필터링
  gradient_clip_norm: 1.0  # 그래디언트 클리핑
  q_value_clip: 100.0  # Q-value 범위 제한
  concentration_range: [0.01, 100.0]  # Dirichlet concentration 범위
  entropy_diff_clip: 5.0  # 엔트로피 차이 클리핑
  safe_checkpoint_interval: 10  # 안전 체크포인트 저장 간격

# 목적함수 설정
objectives:
  # Differential Sharpe
  sharpe_beta: 1.0
  sharpe_ema_alpha: 0.99
  sharpe_epsilon: 1.0e-8

  # CVaR 제약
  cvar_alpha: 0.05 # 5% CVaR
  cvar_target: -0.02 # -2% 이상
  lambda_cvar: 1.0

  # 추가 페널티
  lambda_turn: 0.1 # 턴오버 페널티
  lambda_dd: 0.0 # 낙폭 페널티

  # 보상 정규화
  r_clip: 5.0
  reward_ema_alpha: 0.99

# 학습 설정
train:
  # 오프라인 사전학습
  offline_episodes: 500 # 오프라인 데이터 수집 에피소드 수
  offline_steps: 200000
  offline_batch_size: 512
  offline_eval_interval: 10000

  # 온라인 학습
  online_steps: 300000
  online_batch_size: 512

  # Experience replay
  buffer_size: 100000
  min_buffer_size: 1000
  prioritized_replay: true
  per_alpha: 0.6
  per_beta: 0.4

  # 평가 및 저장
  eval_interval: 5000
  save_interval: 20000
  log_interval: 100

  # 조기 종료
  early_stop_patience: 50000
  early_stop_min_delta: 0.001

# 평가 설정
eval:
  episodes: 10
  benchmark: "equal_weight" # equal_weight|buy_hold|60_40
  metrics: ["sharpe", "cvar", "mdd", "turnover", "returns"]

# 모니터링 설정
monitoring:
  use_wandb: false # 로컬 실험용
  use_tensorboard: true # 기본 활성화
  wandb_project: "finflow-rl"
  wandb_entity: null

  # 안정성 체크
  q_value_check: true
  q_value_threshold: 100.0
  entropy_check: true
  entropy_min: 0.1

  # StabilityMonitor 설정
  stability:
    enabled: true
    max_weight_change: 0.2 # 포트폴리오 가중치 최대 변화 (20%)
    min_effective_assets: 3 # 최소 유효 자산 수
    log_interval: 100 # 로그 요약 출력 간격
    verbose: false # 상세 디버그 로그

  # 자동 개입
  auto_intervention: true
  intervention_threshold: 3.0 # 3-sigma
  rollback_on_divergence: true

# XAI 설정
xai:
  enable_shap: true
  enable_counterfactual: true
  enable_regime_analysis: true
  report_frequency: 10 # 매 10 에피소드마다 리포트

# 데이터 검증 설정
data_validation:
  min_samples: 252 # 최소 1년 데이터
  max_nan_ratio: 0.2 # 최대 20% 결측치
  outlier_iqr_factor: 5 # IQR 5배 이상 이상치
  extreme_return_threshold: 0.5 # 일일 ±50% 이상
  min_variance_threshold: 1.0e-8 # 최소 분산
  max_correlation_threshold: 0.99 # 최대 상관관계
  max_time_gap_days: 5 # 최대 날짜 간격
  forward_fill_limit: 5 # forward fill 최대 제한
  backward_fill_limit: 5 # backward fill 최대 제한
  interpolate_limit: 10 # 보간 최대 제한

# 백테스트 설정
backtest:
  # 거래 비용 모델
  cost_model:
    fixed_cost: 5.0 # 고정 수수료 (달러)
    proportional_cost: 0.001 # 비례 수수료 (0.1%)
    min_cost: 1.0 # 최소 수수료

  # 슬리피지 모델
  slippage_model:
    base_slippage: 0.0005 # 기본 슬리피지 (0.05%)
    volume_factor: 0.1 # 거래량 영향 계수
    volatility_factor: 0.2 # 변동성 영향 계수
    model_type: "square_root" # linear, square_root, exponential

  # 시장 충격 모델
  market_impact_model:
    temporary_impact: 0.1 # 일시적 충격
    permanent_impact: 0.05 # 영구적 충격
    decay_rate: 0.5 # 충격 감소율

  # 차입 비용
  borrowing_cost:
    rate: 0.03 # 연 3% 차입 비용
    margin_requirement: 0.5 # 50% 증거금 요구

  # 제약 조건
  constraints:
    max_position_size: 0.2 # 최대 포지션 크기
    min_trade_size: 100 # 최소 거래 금액
    max_leverage: 2.0 # 최대 레버리지
    min_liquidity: 1000000 # 최소 유동성 요구

# 실거래 시스템 설정
live_trading:
  broker: "alpaca" # alpaca, interactive_brokers, binance
  mode: "paper" # paper or live
  symbols: ["AAPL", "GOOGL", "MSFT", "AMZN", "META"]
  rebalance_frequency: "daily" # minute, hourly, daily
  initial_capital: 100000

  # 위험 관리
  risk:
    max_drawdown: 0.25
    position_limit: 0.2
    daily_loss_limit: 0.05
    var_limit: 0.02
    stop_loss: 0.1
    take_profit: 0.5

  # 주문 실행
  execution:
    order_type: "market" # market, limit
    slippage_buffer: 0.001
    timeout: 30
    retry_count: 3

  # 데이터 설정
  data:
    lookback_period: 30
    update_frequency: 1 # seconds
    data_source: "yfinance" # yfinance, alpaca, polygon
